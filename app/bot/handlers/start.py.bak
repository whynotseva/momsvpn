from aiogram import Router, types, F
from aiogram.filters import Command
from aiogram.types import FSInputFile, CallbackQuery, InlineKeyboardMarkup, InlineKeyboardButton
from app.bot.keyboards.main_menu import main_menu_kb, profile_kb
from app.bot.utils.api_client import api
import os

router = Router()

# Updated Start Handler with User Creation and Terms
@router.message(Command("start"))
async def command_start(message: types.Message):
    # 1. Create user in backend (and Marzban via API)
    username = message.from_user.username or "Anonymous"
    full_name = message.from_user.full_name
    
    # We call API to register user (this will also trigger Marzban sync in backend)
    # Fire and forget or await? Await to ensure user exists before they click buttons.
    await api.create_user(message.from_user.id, username, full_name)
    
    # Welcome with Mom's branding
    text = (
        f"<b>–ü—Ä–∏–≤–µ—Ç, {full_name}! üëã</b>\n\n"
        "–ú—ã —Ä–∞–¥—ã –≤–∏–¥–µ—Ç—å —Ç–µ–±—è –≤ <b>MomsVPN</b> ‚Äî —Å–µ—Ä–≤–∏—Å–µ, –∫–æ—Ç–æ—Ä—ã–π –∑–∞–±–æ—Ç–∏—Ç—Å—è –æ —Ç–≤–æ–µ–π —Å–≤–æ–±–æ–¥–µ –∏ —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏–∏.\n\n"
        "üîê <b>–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π. –ë—ã—Å—Ç—Ä—ã–π. –ü—Ä–æ—Å—Ç–æ–π.</b>\n"
        "–ú—ã –Ω–µ —Ö—Ä–∞–Ω–∏–º –ª–æ–≥–∏ –∏ –ø–æ–º–æ–≥–∞–µ–º —Ç–µ–±–µ –±—ã—Ç—å –Ω–∞ —Å–≤—è–∑–∏ —Å–æ –≤—Å–µ–º –º–∏—Ä–æ–º.\n\n"
        "–ü—Ä–µ–∂–¥–µ —á–µ–º –Ω–∞—á–∞—Ç—å, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–∏–º–∏ –Ω–∞—à–∏ –ø—Ä–∞–≤–∏–ª–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è."
    )
    
    kb = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="‚úÖ –ü—Ä–∏–Ω—è—Ç—å —É—Å–ª–æ–≤–∏—è", callback_data="accept_terms")],
        [InlineKeyboardButton(text="üìú –ß–∏—Ç–∞—Ç—å –ø—Ä–∞–≤–∏–ª–∞", url="https://telegra.ph/Terms-of-Service-MomsVPN")]
    ])
    
    await message.answer(text, reply_markup=kb, parse_mode="HTML")

@router.callback_query(F.data == "accept_terms")
async def terms_accept(callback: CallbackQuery):
    await callback.message.delete()
    
    text = (
        "<b>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –¥–æ–º–æ–π! üè†</b>\n\n"
        "–¢–µ–ø–µ—Ä—å —Ç—ã —á–∞—Å—Ç—å —Å–µ–º—å–∏ MomsVPN.\n"
        "–ü–æ–ª—å–∑—É–π—Å—è –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–æ–º –±–µ–∑ –≥—Ä–∞–Ω–∏—Ü –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π.\n\n"
        "üëá <b>–ß—Ç–æ —Ç—ã —Ö–æ—á–µ—à—å —Å–¥–µ–ª–∞—Ç—å?</b>"
    )
    
    await callback.message.answer(text, reply_markup=main_menu_kb(), parse_mode="HTML")

@router.callback_query(F.data == "back_home")
async def back_home_handler(callback: CallbackQuery):
    await callback.message.delete()
    text = (
        "<b>–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é üè†</b>\n\n"
        "–í—ã–±–µ—Ä–∏ –Ω—É–∂–Ω—ã–π —Ä–∞–∑–¥–µ–ª:"
    )
    await callback.message.answer(text, reply_markup=main_menu_kb(), parse_mode="HTML")

# --- PROFILE & SUB-MENUS ---

@router.callback_query(F.data == "profile")
async def profile_handler(callback: CallbackQuery):
    # Show profile menu (where "My Keys" is located)
    sub_info = await api.get_subscription(callback.from_user.id)
    
    status_text = "–ù–µ –∞–∫—Ç–∏–≤–Ω–∞"
    if sub_info:
        status_map = {"active": "‚úÖ –ê–∫—Ç–∏–≤–Ω–∞", "disabled": "‚ùå –û—Ç–∫–ª—é—á–µ–Ω–∞", "limited": "‚ö†Ô∏è –õ–∏–º–∏—Ç"}
        status_text = status_map.get(sub_info.get("status"), sub_info.get("status", "–ù–µ –∞–∫—Ç–∏–≤–Ω–∞"))

    text = (
        "<b>üë§ –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</b>\n\n"
        f"–í–∞—à ID: <code>{callback.from_user.id}</code>\n"
        f"–°—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏: <b>{status_text}</b>\n\n"
        "–£–ø—Ä–∞–≤–ª—è–π—Ç–µ –ø–æ–¥–ø–∏—Å–∫–æ–π –∏ –∫–ª—é—á–∞–º–∏ –∑–¥–µ—Å—å."
    )
    await callback.message.edit_text(text, reply_markup=profile_kb(), parse_mode="HTML")


@router.callback_query(F.data == "my_keys")
async def my_keys(callback: CallbackQuery):
    from app.bot.utils.crypto import encrypt_vless_link
    from datetime import datetime
    
    # Get user name for personalization
    user_name = callback.from_user.first_name or "–¥—Ä—É–≥"
    
    # Fetch real subscription from API
    sub_info = await api.get_subscription(callback.from_user.id)
    
    if not sub_info:
        await callback.answer("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–ª—é—á–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ /start", show_alert=True)
        return

    # Get the subscription URL (now returns all protocols: WS + Hysteria2 + SS via our proxy)
    subscription_url = sub_info.get("subscription_url", "")
    if not subscription_url:
        await callback.answer("–ö–ª—é—á –µ—â—ë –Ω–µ –≥–æ—Ç–æ–≤. –ü–æ–¥–æ–∂–¥–∏—Ç–µ –º–∏–Ω—É—Ç—É –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.", show_alert=True)
        return
    
    # Encrypt subscription URL using Happ's official API
    # The URL itself (via Nginx proxy) returns all 3 profiles
    encrypted_key = await encrypt_vless_link(subscription_url)
    
    # Format traffic with progress bar
    used_bytes = sub_info.get("used_traffic") or 0
    data_limit = sub_info.get("data_limit") or 0
    used_gb = round(used_bytes / (1024**3), 2)
    
    if data_limit and data_limit > 0:
        limit_gb = int(round(data_limit / (1024**3), 0))
        percent = min(int((used_bytes / data_limit) * 100), 100)
        # Create visual progress bar
        filled = int(percent / 10)
        empty = 10 - filled
        progress_bar = "‚ñì" * filled + "‚ñë" * empty
        traffic_str = f"{progress_bar} {percent}%\n{used_gb} –∏–∑ {limit_gb} –ì–ë"
    else:
        traffic_str = f"‚ñì‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë 0%\n{used_gb} –ì–ë –∏–∑ ‚àû (–±–µ–∑–ª–∏–º–∏—Ç)"
    
    # Format expiration with days remaining
    expire_ts = sub_info.get("expire") or 0
    if expire_ts and expire_ts > 0:
        expire_date = datetime.fromtimestamp(expire_ts)
        days_left = (expire_date - datetime.now()).days
        if days_left > 0:
            expire_text = f"{expire_date.strftime('%d.%m.%Y')} <i>({days_left} –¥–Ω.)</i>"
        else:
            expire_text = f"{expire_date.strftime('%d.%m.%Y')} ‚ö†Ô∏è"
    else:
        expire_text = "‚ôæÔ∏è –ë–µ—Å—Å—Ä–æ—á–Ω–æ"
    
    # Status with emoji
    status_map = {
        "active": "üü¢ –ê–ö–¢–ò–í–ï–ù",
        "disabled": "üî¥ –û–¢–ö–õ–Æ–ß–ï–ù",
        "limited": "üü° –õ–ò–ú–ò–¢",
        "expired": "‚è∞ –ò–°–¢–Å–ö"
    }
    status_raw = sub_info.get("status", "active")
    status_str = status_map.get(status_raw, status_raw.upper())
    
    # Device info
    last_device = sub_info.get("last_device")
    if last_device:
        device_text = f"üì± {last_device}"
    else:
        device_text = "üì± <i>–ï—â—ë –Ω–µ –ø–æ–¥–∫–ª—é—á–∞–ª–∏—Å—å</i>"
    
    # Dynamic server status check
    try:
        server_data = await api.get_server_status()
        if server_data.get("online"):
            server_status = "üü¢ NL (–ù–∏–¥–µ—Ä–ª–∞–Ω–¥—ã) ‚Ä¢ Online"
        else:
            server_status = "üî¥ NL (–ù–∏–¥–µ—Ä–ª–∞–Ω–¥—ã) ‚Ä¢ Offline"
    except:
        server_status = "‚ö™ NL (–ù–∏–¥–µ—Ä–ª–∞–Ω–¥—ã) ‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∫–∞..."
    
    text = (
        f"–ü—Ä–∏–≤–µ—Ç, <b>{user_name}</b>! üëã\n\n"
        
        f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ <b>–°–¢–ê–¢–£–°</b> ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
        f"VPN: <b>{status_str}</b>\n"
        f"–î–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ: <b>{expire_text}</b>\n\n"
        
        f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ <b>–¢–†–ê–§–ò–ö</b> ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
        f"<code>{traffic_str}</code>\n"
        f"<i>–û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è 1-–≥–æ —á–∏—Å–ª–∞ –º–µ—Å—è—Ü–∞</i>\n\n"
        
        f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ <b>–°–ï–†–í–ï–†</b> ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
        f"{server_status}\n\n"
        
        f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ <b>–£–°–¢–†–û–ô–°–¢–í–û</b> ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
        f"{device_text}\n\n"
        
        f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ <b>–í–ê–® –ö–õ–Æ–ß</b> ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
        f"<i>–î–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è HAPP ‚Ä¢ –ù–∞–∂–º–∏ —á—Ç–æ–±—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</i>\n"
        f"<blockquote><code>{encrypted_key}</code></blockquote>\n\n"
        
        f"üì≤ <a href='https://apps.apple.com/app/id6450507239'>–°–∫–∞—á–∞—Ç—å Happ</a> ‚Ä¢ "
        f"üí¨ <a href='https://t.me/momsvpn_support'>–ü–æ–¥–¥–µ—Ä–∂–∫–∞</a>"
    )
    
    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="üîÑ –ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á", callback_data="regenerate_key")],
        [
            InlineKeyboardButton(text="¬´ –ù–∞–∑–∞–¥", callback_data="profile"),
            InlineKeyboardButton(text="üè† –ú–µ–Ω—é", callback_data="back_home")
        ]
    ])
    
    await callback.message.edit_text(text, reply_markup=keyboard, parse_mode="HTML", disable_web_page_preview=True)

@router.callback_query(F.data == "regenerate_key")
async def regenerate_key_handler(callback: CallbackQuery):
    """Regenerate user's VPN key - delete and recreate."""
    telegram_id = callback.from_user.id
    username = callback.from_user.username or "User"
    user_name = callback.from_user.first_name or username
    
    # Show loading message
    await callback.message.edit_text("‚è≥ <b>–ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–∞...</b>\n\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ.", parse_mode="HTML")
    
    try:
        from app.api.services.xray import marzban_service
        from app.bot.utils.crypto import encrypt_vless_link
        
        marzban_username = f"user_{telegram_id}"
        
        # Delete existing user
        await marzban_service.delete_user(marzban_username)
        
        # Create new user
        result = await marzban_service.create_or_update_user(telegram_id, username)
        
        if result:
            await callback.answer("‚úÖ –ö–ª—é—á –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω!", show_alert=True)
            
            # Get new subscription URL and show it
            subscription_url = result.get("subscription_url")
            encrypted_key = await encrypt_vless_link(subscription_url)
            
            text = (
                f"‚úÖ <b>–ö–ª—é—á —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω!</b>\n\n"
                f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ <b>–ù–û–í–´–ô –ö–õ–Æ–ß</b> ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
                f"<i>–°–∫–æ–ø–∏—Ä—É–π –∏ –¥–æ–±–∞–≤—å –≤ Happ:</i>\n"
                f"<blockquote><code>{encrypted_key}</code></blockquote>\n\n"
                f"‚ö†Ô∏è <b>–í–∞–∂–Ω–æ:</b> –£–¥–∞–ª–∏ —Å—Ç–∞—Ä—É—é –ø–æ–¥–ø–∏—Å–∫—É –≤ Happ –∏ –¥–æ–±–∞–≤—å –Ω–æ–≤—É—é!"
            )
            
            keyboard = InlineKeyboardMarkup(inline_keyboard=[
                [InlineKeyboardButton(text="üîë –ú–æ–∏ –∫–ª—é—á–∏", callback_data="my_keys")],
                [InlineKeyboardButton(text="üè† –ú–µ–Ω—é", callback_data="back_home")]
            ])
            
            await callback.message.edit_text(text, reply_markup=keyboard, parse_mode="HTML")
        else:
            await callback.answer("‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª—é—á–∞", show_alert=True)
    except Exception as e:
        await callback.message.edit_text(f"‚ùå –û—à–∏–±–∫–∞: {str(e)[:100]}", parse_mode="HTML")

@router.callback_query(F.data == "buy_sub")
async def buy_sub_handler(callback: CallbackQuery):
    await callback.answer("–°–∫–æ—Ä–æ! –û–ø–ª–∞—Ç–∞ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è...", show_alert=True)

@router.callback_query(F.data == "referral")
async def referral_handler(callback: CallbackQuery):
    await callback.answer("–†–∞–∑–¥–µ–ª –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ üèó", show_alert=True)

@router.callback_query(F.data == "change_server")
async def server_handler(callback: CallbackQuery):
    await callback.answer("–ü–æ–∫–∞ –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Å–µ—Ä–≤–µ—Ä (NL) üá≥üá±", show_alert=True)

