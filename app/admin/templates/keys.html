{% extends "base.html" %}

{% block title %}–ö–ª—é—á–∏ - MomsVPN Admin{% endblock %}
{% block page_title %}üîë –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª—é—á–∞–º–∏{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2>–í—Å–µ –∫–ª—é—á–∏</h2>
        <span class="badge">{{ keys|length }} –≤—Å–µ–≥–æ</span>
    </div>
    <div class="card-body">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Username</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>–¢—Ä–∞—Ñ–∏–∫</th>
                    <th>–õ–∏–º–∏—Ç</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody>
                {% for key in keys %}
                <tr>
                    <td class="username-cell">{{ key.username }}</td>
                    <td>
                        <span class="status-badge status-{{ key.status }}">
                            {% if key.status == 'active' %}üü¢ –ê–∫—Ç–∏–≤–µ–Ω
                            {% elif key.status == 'disabled' %}üî¥ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω
                            {% elif key.status == 'limited' %}üü° –õ–∏–º–∏—Ç
                            {% elif key.status == 'expired' %}‚è∞ –ò—Å—Ç—ë–∫
                            {% else %}{{ key.status }}{% endif %}
                        </span>
                    </td>
                    <td>
                        {% set used_gb = (key.used_traffic or 0) / (1024**3) %}
                        {{ "%.2f"|format(used_gb) }} –ì–ë
                    </td>
                    <td>
                        {% if key.data_limit %}
                        {{ (key.data_limit / (1024**3))|int }} –ì–ë
                        {% else %}
                        ‚ôæÔ∏è –ë–µ–∑–ª–∏–º–∏—Ç
                        {% endif %}
                    </td>
                    <td class="actions-cell">
                        {% if key.status == 'active' %}
                        <form method="POST" action="/admin/keys/{{ key.username }}/block" class="inline-form">
                            <button type="submit" class="btn btn-danger btn-sm"
                                onclick="return confirm('–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á?')">
                                üîí –ë–ª–æ–∫
                            </button>
                        </form>
                        {% else %}
                        <form method="POST" action="/admin/keys/{{ key.username }}/unblock" class="inline-form">
                            <button type="submit" class="btn btn-success btn-sm">
                                üîì –†–∞–∑–±–ª–æ–∫
                            </button>
                        </form>
                        {% endif %}

                        <form method="POST" action="/admin/keys/{{ key.username }}/reset-traffic" class="inline-form">
                            <button type="submit" class="btn btn-warning btn-sm"
                                onclick="return confirm('–°–±—Ä–æ—Å–∏—Ç—å —Ç—Ä–∞—Ñ–∏–∫?')">
                                üîÑ –°–±—Ä–æ—Å
                            </button>
                        </form>

                        <button class="btn btn-primary btn-sm" onclick="showExtendModal('{{ key.username }}')">
                            ‚è∞ –ü—Ä–æ–¥–ª–∏—Ç—å
                        </button>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="5" class="empty-state">–ö–ª—é—á–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Extend Modal -->
<div id="extendModal" class="modal" style="display: none;">
    <div class="modal-content">
        <h3>–ü—Ä–æ–¥–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É</h3>
        <form id="extendForm" method="POST">
            <div class="form-group">
                <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π:</label>
                <input type="number" name="days" value="30" min="1" max="365" class="form-input">
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="hideExtendModal()">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" class="btn btn-primary">–ü—Ä–æ–¥–ª–∏—Ç—å</button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    function showExtendModal(username) {
        document.getElementById('extendForm').action = '/admin/keys/' + username + '/extend';
        document.getElementById('extendModal').style.display = 'flex';
    }

    function hideExtendModal() {
        document.getElementById('extendModal').style.display = 'none';
    }
</script>
{% endblock %}